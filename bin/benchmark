#!/bin/bash

usage() { echo "Usage: $0 
-f filename 
-t targetname 
-r repetitions 
-e entry-function 
-i inputs(ex: 1x4xf32=[0 4 1 3],1x4xf32=[5 2 0 0]) 
-d device-ip(default: 192.168.7.2)" 1>&2; exit 1; }

while getopts ":f:t:r:e:i:d:" opt; do
    case "${opt}" in
        f)
            filename=${OPTARG}
            ;;
        t)
            target=${OPTARG}
            ;;
		r)
			repetitions=${OPTARG}
			;;
		e)
			function=${OPTARG}
			;;
		i)
			inputs=${OPTARG}
			;;
		d)
			device_ip=${OPTARG}
			;;
        *)
            usage
            ;;
    esac
done

# device_ip=192.168.2.49

if [ -z "{$filename}" ] || [ -z "{$target}" ] || [ -z "{$repetitions}" ] || [ -z "{$function}" ] || [ -z "{$inputs}" ]; then
	usage
fi


echo "filename: $device_ip"
# check for benchmark utility on board first

# split inputs into list if needed

name=$(basename $filename)

BENCH_CMD="/opt/iree-benchmark-module --module_file=/tmp/$name --device=local-sync:// --function_input=$inputs --entry_function=$function --benchmark_repetitions=$repetitions"


echo "ip: $device_ip"

scp $filename root@$device_ip:/tmp/

SETUP_CMD="cd /tmp"
CLEANUP_CMD="cd /tmp && rm /tmp/$name"

ssh $device_ip "$SETUP_CMD && $BENCH_CMD && $CLEANUP_CMD"

exit
